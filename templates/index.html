<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U.P.L.I.N.K.</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.lucide.dev/lucide.min.js"></script>
    <style>
        :root {
            --emergency-red: #DC2626;
            --warning-orange: #EA580C;
            --safe-green: #16A34A;
            --connectivity-blue: #0EA5E9;
            --info-purple: #7C3AED;
            --bg-dark: #0F1419;
            --bg-darker: #0B0F14;
            --card-dark: #1E2936;
            --card-hover: #252F3E;
            --text-primary: #FFFFFF;
            --text-secondary: #9CA3AF;
            --text-muted: #6B7280;
            --border: #374151;
            --border-light: #4B5563;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4), 0 4px 6px -2px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ── Header ── */
        .header {
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,41,54,0.95));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 1000;
            padding: 1rem 0;
        }
        .header-content {
            max-width: 1400px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 1.5rem;
        }
        .logo {
            display: flex; align-items: center; gap: 0.75rem;
            font-size: 1.5rem; font-weight: 700; color: var(--connectivity-blue);
        }
        .status-indicators { display: flex; gap: 1rem; align-items: center; }
        .status-dot { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); }
        .dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse-dot 2s infinite; }
        .dot.online  { background: var(--safe-green); }
        .dot.warning { background: var(--warning-orange); }
        .dot.offline { background: var(--emergency-red); }

        /* ── Nav ── */
        .nav-container {
            background: rgba(30,41,54,0.8); backdrop-filter: blur(8px);
            padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border);
        }
        nav {
            display: flex; gap: 0.5rem; max-width: 1400px; margin: 0 auto;
            overflow-x: auto; scrollbar-width: none;
        }
        nav::-webkit-scrollbar { display: none; }
        .nav-btn {
            white-space: nowrap; cursor: pointer;
            padding: 0.75rem 1.5rem; border-radius: 8px;
            border: 1px solid var(--border); background: transparent;
            color: var(--text-secondary); font-weight: 500; font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .nav-btn:hover { border-color: var(--connectivity-blue); color: var(--text-primary); box-shadow: 0 4px 12px rgba(14,165,233,0.2); }
        .nav-btn.active { background: linear-gradient(135deg, var(--connectivity-blue), #0284C7); border-color: var(--connectivity-blue); color: white; }

        /* ── View / Grid ── */
        .view {
            display: none; padding: 2rem 1.5rem;
            max-width: 1400px; margin: 0 auto;
            grid-template-columns: repeat(12, 1fr); gap: 1.5rem;
            animation: fadeIn 0.3s ease-in-out;
        }
        .view.active { display: grid; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .col-span-12 { grid-column: span 12; }
        .col-span-8  { grid-column: span 8; }
        .col-span-6  { grid-column: span 6; }
        .col-span-4  { grid-column: span 4; }
        .col-span-3  { grid-column: span 3; }

        /* ── Cards ── */
        .card {
            background: linear-gradient(135deg, var(--card-dark), rgba(37,47,62,0.8));
            border-radius: 16px; border: 1px solid var(--border);
            padding: 1.5rem; overflow: hidden;
            transition: all 0.3s ease; position: relative;
            backdrop-filter: blur(10px); box-shadow: var(--shadow);
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, var(--connectivity-blue), var(--info-purple));
            opacity: 0; transition: opacity 0.3s ease;
        }
        .card:hover { background: linear-gradient(135deg, var(--card-hover), rgba(42,56,75,0.9)); border-color: var(--border-light); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .card:hover::before { opacity: 1; }
        .card h3 { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; font-weight: 600; font-size: 1.125rem; }

        /* ── Alert ── */
        .alert-critical {
            background: linear-gradient(135deg, var(--emergency-red), #B91C1C);
            border: none; color: white;
            box-shadow: 0 8px 25px rgba(220,38,38,0.4);
            animation: pulse-glow 3s infinite;
        }
        @keyframes pulse-glow {
            0%   { box-shadow: 0 8px 25px rgba(220,38,38,0.4); }
            50%  { box-shadow: 0 8px 35px rgba(220,38,38,0.6); }
            100% { box-shadow: 0 8px 25px rgba(220,38,38,0.4); }
        }
        .action-item {
            display: flex; align-items: flex-start; gap: 1rem;
            margin-top: 0.75rem; padding: 1rem;
            background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 0.925rem;
            border-left: 3px solid rgba(255,255,255,0.3); transition: all 0.2s ease;
        }
        .action-item:hover { background: rgba(0,0,0,0.3); border-left-color: rgba(255,255,255,0.6); }

        /* ── Map ── */
        .map-wrapper {
            height: 450px;
            background: linear-gradient(135deg, #1e293b, #334155);
            position: relative; border-radius: 12px; overflow: hidden;
            border: 2px solid var(--border);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        .map-grid {
            position: absolute; inset: 0;
            background-image:
                linear-gradient(rgba(14,165,233,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(14,165,233,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        .map-label {
            position: absolute; top: 1rem; left: 1rem;
            color: var(--text-secondary); font-size: 0.75rem; font-weight: 500;
            letter-spacing: 1px; text-transform: uppercase;
        }
        .risk-zone {
            position: absolute; border-radius: 50%; cursor: pointer;
            animation: pulse-zone 3s infinite; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 0.75rem;
        }
        .risk-zone:hover { transform: scale(1.15); z-index: 10; }
        .risk-zone.high   { width:100px; height:100px; background: radial-gradient(circle, var(--emergency-red), #B91C1C); top:35%; left:42%; border:3px solid white; box-shadow:0 0 20px rgba(220,38,38,0.6); }
        .risk-zone.medium { width:80px;  height:80px;  background: radial-gradient(circle, var(--warning-orange), #C2410C); top:20%; right:30%; border:3px solid white; box-shadow:0 0 15px rgba(234,88,12,0.5); }
        .risk-zone.low    { width:60px;  height:60px;  background: radial-gradient(circle, var(--safe-green), #15803D); bottom:25%; left:25%; border:3px solid white; box-shadow:0 0 10px rgba(22,163,74,0.4); }

        @keyframes pulse-zone {
            0%   { opacity: 0.8; }
            50%  { opacity: 0.6; }
            100% { opacity: 0.8; }
        }

        /* ── Evidence ── */
        .evidence-card { border-left: 4px solid var(--connectivity-blue); background: linear-gradient(135deg, var(--card-dark), rgba(14,165,233,0.05)); }
        .evidence-content { padding: 1rem; background: rgba(14,165,233,0.05); border-radius: 8px; border: 1px solid rgba(14,165,233,0.2); margin-top: 0.75rem; }

        /* ── Pills ── */
        .status-pill {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem; border-radius: 25px;
            background: rgba(0,0,0,0.3); font-size: 0.8rem;
            margin: 0.25rem 0.5rem 0.25rem 0;
            border: 1px solid var(--border); transition: all 0.2s ease;
        }
        .pulse-dot { width:8px; height:8px; border-radius:50%; background:var(--safe-green); animation:pulse-dot 1.5s infinite; }
        @keyframes pulse-dot { 0%,100% { opacity:1; transform:scale(1); } 50% { opacity:0.5; transform:scale(1.2); } }

        /* ── Telemetry Stats ── */
        .telemetry-stat { display:flex; justify-content:space-between; align-items:center; padding:1rem 0; border-bottom:1px solid var(--border); transition:all 0.2s ease; }
        .telemetry-stat:last-child { border-bottom: none; }
        .stat-value { font-weight:600; font-size:1.1rem; }
        .stat-label { color:var(--text-secondary); font-size:0.875rem; }

        /* ── Charts ── */
        .chart-container { height:350px; width:100%; padding:1rem; background:rgba(0,0,0,0.2); border-radius:12px; border:1px solid var(--border); }

        /* ── Realtime values ── */
        .realtime-value {
            font-size:2.5rem; font-weight:700; text-align:center; margin:1rem 0;
            background: linear-gradient(135deg, var(--connectivity-blue), var(--info-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .unit-label { font-size:0.875rem; color:var(--text-secondary); text-align:center; margin-bottom:1rem; }

        /* ── Network ── */
        .network-status {
            display:grid; grid-template-columns:1fr auto; gap:1rem; align-items:center;
            padding:1.25rem; background:rgba(0,0,0,0.1); border-radius:12px;
            border:1px solid var(--border); margin-bottom:1rem; transition:all 0.3s ease;
        }
        .network-status:hover { background:rgba(0,0,0,0.2); border-color:var(--border-light); }
        .network-info h4 { font-weight:600; margin-bottom:0.25rem; }
        .network-info p  { color:var(--text-secondary); font-size:0.875rem; }
        .connection-badge { padding:0.5rem 1rem; border-radius:20px; font-weight:600; font-size:0.8rem; text-transform:uppercase; letter-spacing:0.5px; }
        .connection-badge.online  { background:rgba(22,163,74,0.2);  color:var(--safe-green);    border:1px solid var(--safe-green); }
        .connection-badge.warning { background:rgba(234,88,12,0.2);  color:var(--warning-orange); border:1px solid var(--warning-orange); }
        .connection-badge.offline { background:rgba(220,38,38,0.2);  color:var(--emergency-red);  border:1px solid var(--emergency-red); }

        /* ── Skeleton loader ── */
        .skeleton { background: linear-gradient(90deg, #1e2936 25%, #252f3e 50%, #1e2936 75%); background-size: 200% 100%; animation: skeleton-load 1.5s infinite; border-radius: 6px; }
        @keyframes skeleton-load { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* ── Responsive ── */
        @media (max-width: 1200px) {
            .col-span-8, .col-span-4 { grid-column: span 12; }
            .col-span-6 { grid-column: span 12; }
            .col-span-3 { grid-column: span 6; }
        }
        @media (max-width: 768px) {
            .col-span-8, .col-span-6, .col-span-4, .col-span-3 { grid-column: span 12; }
            .view { padding: 1rem; gap: 1rem; }
            .header-content { padding: 0 1rem; flex-direction: column; gap: 1rem; }
            .logo { font-size: 1.25rem; }
            .status-indicators { justify-content: center; }
        }
    </style>
</head>
<body>

<!-- ══ HEADER ══ -->
<div class="header">
    <div class="header-content">
        <div class="logo">
            <i data-lucide="satellite"></i>
            U.P.L.I.N.K.
        </div>
        <div class="status-indicators">
            <div class="status-dot">
                <div class="dot online"></div>
                System Online
            </div>
            <div class="status-dot">
                <div class="dot online"></div>
                <span id="live-timestamp">--:--:--</span>
            </div>
        </div>
    </div>
</div>

<!-- ══ NAV ══ -->
<div class="nav-container">
    <nav>
        <button class="nav-btn active" onclick="switchTab('risk-view', this)">
            <i data-lucide="shield-alert" style="width:16px;height:16px;margin-right:0.5rem;"></i>
            Risk Management
        </button>
        <button class="nav-btn" onclick="switchTab('telemetry-view', this)">
            <i data-lucide="activity" style="width:16px;height:16px;margin-right:0.5rem;"></i>
            Field Telemetry
        </button>
        <button class="nav-btn" onclick="switchTab('network-view', this)">
            <i data-lucide="network" style="width:16px;height:16px;margin-right:0.5rem;"></i>
            Network Status
        </button>
        <button class="nav-btn" onclick="switchTab('analytics-view', this)">
            <i data-lucide="bar-chart-3" style="width:16px;height:16px;margin-right:0.5rem;"></i>
            Analytics
        </button>
    </nav>
</div>

<!-- ══════════════════════════════════
     RISK MANAGEMENT VIEW
══════════════════════════════════ -->
<div id="risk-view" class="view active">

    <!-- Critical Banner -->
    <div class="card col-span-12 alert-critical">
        <h3><i data-lucide="alert-triangle"></i> CRITICAL ACTIONS REQUIRED</h3>
        <div class="action-item">
            <i data-lucide="alert-circle" style="width:20px;height:20px;margin-top:2px;color:rgba(255,255,255,0.8);"></i>
            <div><strong>HIGH PRIORITY:</strong> Deploy emergency response teams to Zone 01 — Leptospirosis outbreak risk detected</div>
        </div>
        <div class="action-item">
            <i data-lucide="radio" style="width:20px;height:20px;margin-top:2px;color:rgba(255,255,255,0.8);"></i>
            <div><strong>COMMUNICATION:</strong> Broadcast health advisory on Radio Channel 7 (AM 702 kHz)</div>
        </div>
        <div class="action-item">
            <i data-lucide="users" style="width:20px;height:20px;margin-top:2px;color:rgba(255,255,255,0.8);"></i>
            <div><strong>COORDINATION:</strong> Alert barangay health workers for immediate surveillance deployment</div>
        </div>
    </div>

    <!-- Map -->
    <div class="card col-span-8">
        <h3><i data-lucide="map"></i> Live Environmental Risk Assessment</h3>
        <p style="font-size:0.875rem;color:var(--text-secondary);margin-bottom:1rem;">
            Interactive risk zones updated every 15 minutes. Click zones for detailed analysis.
        </p>
        <div class="map-wrapper">
            <div class="map-grid"></div>
            <div class="map-label">RISK ZONE MAP — REAL-TIME</div>
            <div class="risk-zone high"   onclick="selectZone('Z01')" title="Zone 01: Critical Risk">Z01</div>
            <div class="risk-zone medium" onclick="selectZone('Z02')" title="Zone 02: Medium Risk">Z02</div>
            <div class="risk-zone low"    onclick="selectZone('Z03')" title="Zone 03: Low Risk">Z03</div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-span-4" style="display:flex;flex-direction:column;gap:1.5rem;">
        <div class="card evidence-card">
            <h3><i data-lucide="microscope"></i> Scientific Evidence</h3>
            <div id="evidence-display" class="evidence-content">
                <p style="color:var(--text-secondary);font-size:0.9rem;">
                    Select a risk zone on the map to view peer-reviewed analysis and recommended interventions.
                </p>
            </div>
        </div>

        <div class="card">
            <h3><i data-lucide="broadcast"></i> Communication Status</h3>
            <div class="status-pill"><div class="pulse-dot"></div> SIM800 SMS: ACTIVE (47 messages sent)</div>
            <div class="status-pill"><div class="pulse-dot"></div> Radio CH-7: BROADCASTING</div>
            <div class="status-pill"><div class="pulse-dot"></div> LoRa Network: 12 nodes online</div>
        </div>
    </div>
</div>

<!-- ══════════════════════════════════
     FIELD TELEMETRY VIEW
══════════════════════════════════ -->
<div id="telemetry-view" class="view">

    <!-- FSU Card -->
    <div class="card col-span-3">
        <h3><i data-lucide="cpu"></i> FSU-001</h3>
        <div style="text-align:center;padding:2rem 0;">
            <i data-lucide="container" style="width:64px;height:64px;color:var(--connectivity-blue);"></i>
        </div>
        <div class="realtime-value" id="battery-level">—</div>
        <div class="unit-label">Battery Health</div>
        <div class="telemetry-stat">
            <span class="stat-label">GPS Accuracy</span>
            <span class="stat-value" id="gps-accuracy" style="color:var(--safe-green);">—</span>
        </div>
        <div class="telemetry-stat">
            <span class="stat-label">Satellites</span>
            <span class="stat-value" id="satellites">—</span>
        </div>
        <div class="telemetry-stat">
            <span class="stat-label">LoRa RSSI</span>
            <span class="stat-value" id="lora-rssi">—</span>
        </div>
    </div>

    <!-- Telemetry Chart -->
    <div class="card col-span-6">
        <h3><i data-lucide="activity"></i> Water Quality Telemetry</h3>
        <div class="chart-container">
            <canvas id="telemetryChart"></canvas>
        </div>
    </div>

    <!-- Current Readings -->
    <div class="card col-span-3">
        <h3><i data-lucide="thermometer"></i> Current Readings</h3>
        <div style="text-align:center;margin:1.5rem 0;">
            <div class="realtime-value" id="turbidity-value">—</div>
            <div class="unit-label">Turbidity (NTU)</div>
        </div>
        <div style="text-align:center;margin:1.5rem 0;">
            <div class="realtime-value" id="conductivity-value">—</div>
            <div class="unit-label">Conductivity (μS/cm)</div>
        </div>
        <div style="text-align:center;margin:1.5rem 0;">
            <div class="realtime-value" id="temperature-value" style="color:var(--safe-green);">—</div>
            <div class="unit-label">Temperature (°C)</div>
        </div>
    </div>
</div>

<!-- ══════════════════════════════════
     NETWORK STATUS VIEW
══════════════════════════════════ -->
<div id="network-view" class="view">
    <div class="card col-span-12">
        <h3><i data-lucide="network"></i> Resilient Communication Network</h3>
        <div id="network-list">
            <!-- Populated by JS from /api/network-status -->
            <div class="skeleton" style="height:80px;margin-bottom:1rem;"></div>
            <div class="skeleton" style="height:80px;margin-bottom:1rem;"></div>
            <div class="skeleton" style="height:80px;margin-bottom:1rem;"></div>
            <div class="skeleton" style="height:80px;"></div>
        </div>
    </div>
</div>

<!-- ══════════════════════════════════
     ANALYTICS VIEW
══════════════════════════════════ -->
<div id="analytics-view" class="view">
    <div class="card col-span-6">
        <h3><i data-lucide="trending-up"></i> Risk Trend Analysis</h3>
        <div class="chart-container">
            <canvas id="riskTrendChart"></canvas>
        </div>
    </div>
    <div class="card col-span-6">
        <h3><i data-lucide="pie-chart"></i> Alert Distribution</h3>
        <div class="chart-container">
            <canvas id="alertDistributionChart"></canvas>
        </div>
    </div>
</div>


<!-- ══════════════════════════════════
     JAVASCRIPT
══════════════════════════════════ -->
<script>
lucide.createIcons();

// ── Live Timestamp ──────────────────────────
function updateTimestamp() {
    document.getElementById('live-timestamp').textContent =
        new Date().toLocaleTimeString('en-US', { hour12: false });
}
setInterval(updateTimestamp, 1000);
updateTimestamp();


// ── Tab Switching ───────────────────────────
function switchTab(viewId, btn) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(viewId).classList.add('active');
    btn.classList.add('active');

    if (viewId === 'network-view')   loadNetworkStatus();
    if (viewId === 'analytics-view') setTimeout(initAnalyticsCharts, 100);
}


// ── Risk Zone: Select & Fetch Evidence ─────
let riskZonesCache = null;

async function loadRiskZones() {
    const res = await fetch('/api/risk-zones');
    riskZonesCache = await res.json();
    // Auto-highlight Z01 on load
    selectZone('Z01');
}

function selectZone(zoneId) {
    if (!riskZonesCache) return;
    const zone = riskZonesCache.find(z => z.id === zoneId);
    if (!zone) return;

    const colorMap = {
        high:   { bg: 'rgba(220,38,38,0.1)',  border: 'var(--emergency-red)',   label: 'CRITICAL' },
        medium: { bg: 'rgba(234,88,12,0.1)',  border: 'var(--warning-orange)', label: 'MODERATE' },
        low:    { bg: 'rgba(22,163,74,0.1)',  border: 'var(--safe-green)',     label: 'SAFE' }
    };
    const c = colorMap[zone.level];

    const triggerList = zone.triggers.map(t => `• ${t}`).join('<br>');

    document.getElementById('evidence-display').innerHTML = `
        <h4 style="margin-bottom:0.75rem;">${zone.id} — ${zone.disease}: ${c.label}</h4>
        <div style="background:${c.bg};padding:0.75rem;border-radius:6px;margin:0.75rem 0;border-left:3px solid ${c.border};">
            <strong>Risk Indicators:</strong><br>
            ${triggerList}
        </div>
        <p style="font-size:0.85rem;color:var(--text-secondary);">
            <em>Reference: ${zone.reference}</em>
        </p>
    `;
}


// ── Telemetry: Fetch Live Readings ─────────
async function fetchTelemetry() {
    try {
        const res  = await fetch('/api/telemetry');
        const data = await res.json();

        document.getElementById('turbidity-value').textContent   = data.turbidity;
        document.getElementById('conductivity-value').textContent = data.conductivity;
        document.getElementById('temperature-value').textContent  = data.temperature;
        document.getElementById('battery-level').textContent      = data.battery + '%';
        document.getElementById('gps-accuracy').textContent       = '±' + data.gps_accuracy + 'm';
        document.getElementById('satellites').textContent         = data.satellites + '/16';
        document.getElementById('lora-rssi').textContent          = data.lora_rssi + ' dBm';
        document.getElementById('live-timestamp').textContent     = data.timestamp;

        // Push new point to chart
        if (telemetryChart) {
            const now = new Date().toLocaleTimeString('en-US', { hour12:false, hour:'2-digit', minute:'2-digit' });
            telemetryChart.data.labels.push(now);
            telemetryChart.data.datasets[0].data.push(data.turbidity);
            telemetryChart.data.datasets[1].data.push(data.conductivity);

            // Keep last 10 points
            if (telemetryChart.data.labels.length > 10) {
                telemetryChart.data.labels.shift();
                telemetryChart.data.datasets[0].data.shift();
                telemetryChart.data.datasets[1].data.shift();
            }
            telemetryChart.update('none');
        }
    } catch (e) {
        console.error('Telemetry fetch error:', e);
    }
}


// ── Telemetry Chart (initial history) ──────
let telemetryChart = null;

async function initTelemetryChart() {
    const res  = await fetch('/api/telemetry/history');
    const data = await res.json();

    const ctx = document.getElementById('telemetryChart').getContext('2d');
    telemetryChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [
                {
                    label: 'Turbidity (NTU)',
                    data: data.turbidity,
                    borderColor: '#0EA5E9',
                    backgroundColor: 'rgba(14,165,233,0.1)',
                    fill: true, tension: 0.4, borderWidth: 3,
                    pointBackgroundColor: '#0EA5E9', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 5
                },
                {
                    label: 'Conductivity (μS/cm)',
                    data: data.conductivity,
                    borderColor: '#DC2626',
                    backgroundColor: 'rgba(220,38,38,0.1)',
                    fill: true, tension: 0.4, borderWidth: 3, borderDash: [5,5],
                    pointBackgroundColor: '#DC2626', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { labels: { color: '#F8FAFC', font: { family: 'Inter', size: 12 }, padding: 20 } },
                tooltip: { backgroundColor: 'rgba(15,20,25,0.9)', titleColor: '#F8FAFC', bodyColor: '#F8FAFC', borderColor: '#374151', borderWidth: 1, cornerRadius: 8, padding: 12 }
            },
            scales: {
                y: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF', font: { family: 'Inter', size: 11 } } },
                x: { grid: { display: false }, ticks: { color: '#9CA3AF', font: { family: 'Inter', size: 11 } } }
            }
        }
    });
}


// ── Network Status ──────────────────────────
async function loadNetworkStatus() {
    try {
        const res   = await fetch('/api/network-status');
        const nodes = await res.json();
        const list  = document.getElementById('network-list');

        list.innerHTML = nodes.map(n => `
            <div class="network-status">
                <div class="network-info">
                    <h4>${n.name}</h4>
                    <p>${n.detail}</p>
                </div>
                <div class="connection-badge ${n.level}">${n.status}</div>
            </div>
        `).join('');
    } catch (e) {
        console.error('Network status error:', e);
    }
}


// ── Analytics Charts ────────────────────────
let analyticsInitialized = false;

async function initAnalyticsCharts() {
    if (analyticsInitialized) return;
    analyticsInitialized = true;

    const res  = await fetch('/api/analytics');
    const data = await res.json();

    // Risk Trend
    new Chart(document.getElementById('riskTrendChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: data.risk_trend.labels,
            datasets: [
                { label: 'High Risk Events',   data: data.risk_trend.high,   borderColor: '#DC2626', backgroundColor: 'rgba(220,38,38,0.1)', tension: 0.4, fill: true },
                { label: 'Medium Risk Events', data: data.risk_trend.medium, borderColor: '#EA580C', backgroundColor: 'rgba(234,88,12,0.1)', tension: 0.4, fill: true }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#F8FAFC', font: { family: 'Inter' } } } },
            scales: {
                y: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF' } },
                x: { grid: { display: false },  ticks: { color: '#9CA3AF' } }
            }
        }
    });

    // Alert Distribution
    new Chart(document.getElementById('alertDistributionChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: data.alert_distribution.labels,
            datasets: [{ data: data.alert_distribution.data, backgroundColor: ['#DC2626','#EA580C','#F59E0B','#16A34A'], borderWidth: 0 }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#F8FAFC', font: { family: 'Inter' }, padding: 20 } } }
        }
    });
}


// ── Boot Sequence ───────────────────────────
loadRiskZones();
initTelemetryChart().then(() => {
    fetchTelemetry();
    setInterval(fetchTelemetry, 5000);
});
</script>
</body>
</html>